<!DOCTYPE html>
<html>
<head>
  <title>🚚 Logistics Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2rem; max-width: 900px; margin: auto; }
    button { padding: 0.5rem 1rem; margin: 0.5rem; font-weight: bold; }
    .batch { border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; border-radius: 8px; }
    .qr { margin-top: 1rem; }
  </style>
</head>
<body>
  <h2>🚚 Logistics Dashboard</h2>
  <button id="connectWallet">🔗 Connect Wallet</button>
  <div id="walletAddress"></div>

  <button onclick="loadLogisticsBatches()">📦 Load My Batches</button>
  <div id="batchList"></div>

  <script>
    const registryAddress = "0xd1b76e1002206467492dfBD96eA1F3D0fdc917EC";

    const registryABI = [ /* your registry ABI – include full from earlier */ ];
    const batchABI = [ /* your batch ABI – include full from earlier */ ];

    let provider, signer, userAddress, registry;

    document.getElementById("connectWallet").onclick = async () => {
      if (!window.ethereum) {
        alert("Please install MetaMask to use this feature.");
        return;
      }

      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      userAddress = await signer.getAddress();
      registry = new ethers.Contract(registryAddress, registryABI, signer);

      document.getElementById("walletAddress").innerText = `✅ Connected: ${userAddress}`;
    };

    async function loadLogisticsBatches() {
      if (!registry || !userAddress) {
        alert("Please connect your wallet first.");
        return;
      }

      const batchAddresses = await registry.getBatchesByLogistics(userAddress);
      const container = document.getElementById("batchList");
      container.innerHTML = "";

      const stages = ["Ordered", "Manufactured", "Picked Up", "Delivered", "Installed"];

      for (let addr of batchAddresses) {
        const batchContract = new ethers.Contract(addr, batchABI, signer);
        const [description, batchId, currentStage] = await Promise.all([
          batchContract.description(),
          batchContract.batchId(),
          batchContract.currentStage()
        ]);

        const div = document.createElement("div");
        div.className = "batch";
        div.innerHTML = `
          <strong>Batch ID:</strong> ${batchId}<br/>
          <strong>Description:</strong> ${description}<br/>
          <strong>Stage:</strong> <b>${stages[currentStage]}</b><br/>
          <div id="qr-${batchId}" class="qr"></div>
          <button onclick="advanceStage('${addr}', 'markPickedUp')">📦 Mark Picked Up</button>
          <button onclick="advanceStage('${addr}', 'markDelivered')">🚚 Mark Delivered</button>
        `;
        container.appendChild(div);

        // Generate QR code
        new QRCode(document.getElementById(`qr-${batchId}`), {
          text: `Batch ID: ${batchId}\nContract: ${addr}`,
          width: 128,
          height: 128
        });
      }
    }

    async function advanceStage(contractAddress, method) {
      const contract = new ethers.Contract(contractAddress, batchABI, signer);
      try {
        const tx = await contract[method]();
        await tx.wait();
        alert(`✅ ${method} successful`);
        loadLogisticsBatches(); // refresh
      } catch (err) {
        console.error(err);
        alert("❌ Failed to update stage");
      }
    }
  </script>
</body>
</html>
