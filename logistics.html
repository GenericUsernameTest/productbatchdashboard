<!DOCTYPE html>
<html>
<head>
  <title>üöö Logistics Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2rem; max-width: 900px; margin: auto; }
    button { padding: 0.5rem 1rem; margin: 0.5rem; font-weight: bold; }
    .batch { border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; border-radius: 8px; }
    .qr { margin-top: 1rem; }
  </style>
</head>
<body>
  <h2>üöö Logistics Dashboard</h2>
  <button id="connectWallet">üîó Connect Wallet</button>
  <div id="walletAddress"></div>

  <button onclick="loadLogisticsBatches()">üì¶ Load My Batches</button>
  <div id="batchList"></div>

  <script>
    const registryAddress = "0xd1b76e1002206467492dfBD96eA1F3D0fdc917EC";

<script>
const registryAddress = "0xd1b76e1002206467492dfBD96eA1F3D0fdc917EC";

const registryABI = [
  {
    "inputs": [
      { "internalType": "string", "name": "_description", "type": "string" },
      { "internalType": "string", "name": "_batchId", "type": "string" },
      { "internalType": "address", "name": "_factory", "type": "address" },
      { "internalType": "address", "name": "_logistics", "type": "address" },
      { "internalType": "address", "name": "_installer", "type": "address" }
    ],
    "name": "createProductBatch",
    "outputs": [{ "internalType": "address", "name": "", "type": "address" }],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      { "internalType": "address", "name": "_logistics", "type": "address" }
    ],
    "name": "getBatchesByLogistics",
    "outputs": [{ "internalType": "address[]", "name": "", "type": "address[]" }],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "getAllBatches",
    "outputs": [{
      "components": [
        { "internalType": "address", "name": "contractAddress", "type": "address" },
        { "internalType": "string", "name": "batchId", "type": "string" },
        { "internalType": "string", "name": "description", "type": "string" },
        { "internalType": "address", "name": "factory", "type": "address" },
        { "internalType": "address", "name": "logistics", "type": "address" },
        { "internalType": "address", "name": "installer", "type": "address" }
      ],
      "internalType": "struct ProductBatchRegistry.BatchRecord[]",
      "name": "",
      "type": "tuple[]"
    }],
    "stateMutability": "view",
    "type": "function"
  }
];

const batchABI = [
  { "inputs": [], "name": "markDelivered", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
  { "inputs": [], "name": "markInstalled", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
  { "inputs": [], "name": "markManufactured", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
  { "inputs": [], "name": "markPickedUp", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
  {
    "inputs": [],
    "name": "description",
    "outputs": [{ "internalType": "string", "name": "", "type": "string" }],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "currentStage",
    "outputs": [{ "internalType": "uint8", "name": "", "type": "uint8" }],
    "stateMutability": "view",
    "type": "function"
  }
];

let provider, signer, registry;

async function connectWallet() {
  if (!window.ethereum) {
    alert("MetaMask not detected.");
    return;
  }
  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();

  const userAddress = await signer.getAddress();
  document.getElementById("walletAddress").innerText = `‚úÖ Connected: ${userAddress}`;

  registry = new ethers.Contract(registryAddress, registryABI, provider);
}

async function loadLogisticsBatches() {
  const userAddress = await signer.getAddress();
  const batchAddresses = await registry.getBatchesByLogistics(userAddress);

  const container = document.getElementById("batchList");
  container.innerHTML = "";

  const stages = ["Ordered", "Manufactured", "Picked Up", "Delivered", "Installed"];

  for (let addr of batchAddresses) {
    const batch = new ethers.Contract(addr, batchABI, provider);
    const desc = await batch.description();
    const stage = await batch.currentStage();

    const div = document.createElement("div");
    div.className = "batch";
    div.innerHTML = `
      <strong>Contract:</strong> ${addr}<br/>
      <strong>Description:</strong> ${desc}<br/>
      <strong>Current Stage:</strong> ${stages[stage]}
    `;
    container.appendChild(div);
  }
}
</script>

    let provider, signer, userAddress, registry;

    document.getElementById("connectWallet").onclick = async () => {
      if (!window.ethereum) {
        alert("Please install MetaMask to use this feature.");
        return;
      }

      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      userAddress = await signer.getAddress();
      registry = new ethers.Contract(registryAddress, registryABI, signer);

      document.getElementById("walletAddress").innerText = `‚úÖ Connected: ${userAddress}`;
    };

    async function loadLogisticsBatches() {
      if (!registry || !userAddress) {
        alert("Please connect your wallet first.");
        return;
      }

      const batchAddresses = await registry.getBatchesByLogistics(userAddress);
      const container = document.getElementById("batchList");
      container.innerHTML = "";

      const stages = ["Ordered", "Manufactured", "Picked Up", "Delivered", "Installed"];

      for (let addr of batchAddresses) {
        const batchContract = new ethers.Contract(addr, batchABI, signer);
        const [description, batchId, currentStage] = await Promise.all([
          batchContract.description(),
          batchContract.batchId(),
          batchContract.currentStage()
        ]);

        const div = document.createElement("div");
        div.className = "batch";
        div.innerHTML = `
          <strong>Batch ID:</strong> ${batchId}<br/>
          <strong>Description:</strong> ${description}<br/>
          <strong>Stage:</strong> <b>${stages[currentStage]}</b><br/>
          <div id="qr-${batchId}" class="qr"></div>
          <button onclick="advanceStage('${addr}', 'markPickedUp')">üì¶ Mark Picked Up</button>
          <button onclick="advanceStage('${addr}', 'markDelivered')">üöö Mark Delivered</button>
        `;
        container.appendChild(div);

        // Generate QR code
        new QRCode(document.getElementById(`qr-${batchId}`), {
          text: `Batch ID: ${batchId}\nContract: ${addr}`,
          width: 128,
          height: 128
        });
      }
    }

    async function advanceStage(contractAddress, method) {
      const contract = new ethers.Contract(contractAddress, batchABI, signer);
      try {
        const tx = await contract[method]();
        await tx.wait();
        alert(`‚úÖ ${method} successful`);
        loadLogisticsBatches(); // refresh
      } catch (err) {
        console.error(err);
        alert("‚ùå Failed to update stage");
      }
    }
  </script>
</body>
</html>
